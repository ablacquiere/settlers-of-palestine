<!DOCTYPE HTML>

<html>

<head>
	
	<meta charset="UTF-8">
	<title>The Settlers of Palestine</title>
	<script src="js/jquery-2.2.4.js"></script>
	<script src="js/bootstrap.js"/></script>
	<link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
	<link type="text/css" rel="stylesheet" href="css/bootstrap.css">
	<script src="js/d3.v2.js"></script>

	<script src="js/rickshaw.min.js"></script>
	
	

	
	<style>
		
		.jumbotron {
			max-width: 1920px;
			border-radius: 0 !important;
			background-color: #dddddd;
		}
				
		#headerContent {
			background-color: #0992b2;
			border-radius: 20px;	
			margin-bottom: 1em;
			//opacity: 0;
		}
		
		#mainContent {
			background-color: #ffa858;
			border-radius: 20px;
			margin-bottom: 1em;	
			//opacity: 0;			
		}
		
		#answerContent {
			background-color: #ffa858;
			border-radius: 20px;		
			margin-bottom: 2em;	
			//opacity: 0;
		}
		
		#chart_container{
			padding: 0 50px 0 20;
		}
		
		/*#hook-text {
			font-weight: bold;
			font-size:
		}*/
		
		.main-group {
			margin: 0 2% 0 2%;
		}
		
		.fadeInAnimation {
			animation: fadeIn 2s linear;
		}
		
		/* Chrome, Safari, Opera */
		@-webkit-keyframes fadeIn {
    		from { opacity:0; }
    		to { opacity: 1; }
		}

		@keyframes fadeIn {
			from { opacity: 0; }
			to { opacity: 1; }		
		}		
		
		.question-canvas{
			white-space: pre-line; /*Not sure why this works... Need to check compatibility with all browsers/platforms http://stackoverflow.com/questions/9980416/how-can-i-insert-new-line-carriage-returns-into-an-element-textcontent*/		
		}
		
		.detail_swatch {
			float:right; 
			width: 10px; 
			height: 10px; 
			margin: 2.5px 0 0 95px 
		}
				
	</style>

</head>

<body>
	
	<div class="container-fluid">
		
		<img src="images/header_1920.jpg" class="img-responsive" id="header-image">
		
		<div class="jumbotron">		
			
			<div class="row">
				<div class="col-xs-6" id="headerContent">				
					<h1 class="text-center question-canvas" id="era-title"></h1>
					<h2 class="text-center question-canvas" id="hook-text"></h2>
				</div>
			</div>
			
			<div class="well well-lg main-group" id="mainContent">	
				<p class="text-justify question-canvas" id="text-canvas"></p>
			</div>
		
			<div class="row">
				<div class="col-xs-4 pull-right well well-sm main-group" id="answerContent">
					<div class="text-right question-canvas" id="answer-canvas"></div> 
				</div>
			</div>
						
			<div class="well well-lg" id="chart_container">
				<div id="chart"></div>
				<div id="x_axis"></div>
			</div>	
		
		</div>
	
	</div>


	<script language="JavaScript">
	
			var score = {};
			var QUESTIONS_PER_ERA = 2;
			var QUESTIONS_PER_GAME = 20;
		var graph;
		
		var scoreData = { "pop": [], "rep": [], "econ": [], "sol": []};

		var setupMultipliers = {"econ":1,"pop":1,"rep":1,"sol":1};
		var jsonData;
		
		var scoreData = {};
		
		var gameObject = {};
		
		
		var hDisplay = document.querySelector("#hook-text");
		var eDisplay = document.querySelector("#era-title");			
		var tDisplay = document.querySelector("#text-canvas");
		var aDisplay = document.querySelector("#answer-canvas");
			
		var counter = 1;
		var displayContentComplete = false;
		
		
		$(window).on('resize', function(){
			graph.configure({
				width: window.innerWidth - 200,
				height: 250
			});
			graph.render();
		});
		
		function frame() {
			if (!displayContentComplete) {
				resetCanvas();
				
				if (gameObject.gameContent.length > 0) {					
					displayContent();
					
				} else {
					displayGameOver();
				}
			}
			requestAnimationFrame(frame);
		}



		function displayGameOver() {
			
			var h = document.createTextNode("Game Over");
			var t = document.createTextNode("Your kibbutz has managed to persist through many hardships to contemporary times. Was the 'experiment' a success? Only you can judge...");					
			hDisplay.appendChild(h);
			tDisplay.appendChild(t)
			
			var para = createPElement("Click to replay...",0,0);
			
			para.addEventListener("click", function() {
				loadScript("data/SoPQuestionDataTEMP.json", gameSetup);
				displayContentComplete = false;
			});
			aDisplay.appendChild(para);	

			displayContentComplete = true;
		}
		
		function loadScript(url, callback) {
			var head = document.getElementsByTagName('head')[0];
			var script = document.createElement('script');
			script.type = 'text/javascript';
			script.src = url;

			script.onreadystatechange = callback;
			script.onload = callback;
			
			head.appendChild(script);
		}

		function gameSetup() {

			gameObject.gameContent = generateGameContent(SoPQuestionData);	
			gameObject.gameScore = {"pop": 0, "econ": 0, "rep": 0, "sol": 0};
			gameObject.contentCount = 0;
			
			drawGraph();
			
			requestAnimationFrame(frame);

		}
		
		
		function generateGameContent(json) {
		
			var arr = [];
					
			for (var i=0; i<json.length; i++) {
				
				arr.push(json[i].newEra);
				var	questionArray = json[i].questions;	
				
				if (json[i].type == "setup") {
					arr.push(questionArray[0]);
					arr.push(questionArray[1]);
				} else {						
					var bossQuestionIndex = getIndex(questionArray, "B");
									
					if (bossQuestionIndex > 0) {					
						var tempObj = questionArray.splice(bossQuestionIndex,1);
						arr.push(questionArray.splice(Math.floor(questionArray.length*Math.random()),1)[0]);
						arr.push(tempObj[0]);
					} else {
						for (var j=0; j<QUESTIONS_PER_ERA; j++) {
							arr.push(questionArray.splice(Math.floor(questionArray.length*Math.random()),1)[0]);
						}
					}				
				}
			}
			
			return arr;

		}
		
		function getIndex(data, type) {
			
			for (var i=0; i<data.length; i++) {
				if (data[i].type === type) {
					return i;					
				}												
			}
			return -1;
		}
		
		loadScript("data/SoPQuestionDataTEMP.json", gameSetup);	
		
		
		function displayContent() {
			var headerDiv = document.querySelector("#headerContent");
			var mainDiv = document.querySelector("#mainContent");
			var answerDiv = document.querySelector("#answerContent");
			
			var e, h, t, a;
			
			var curGameContent = gameObject.gameContent.shift();
			
			if (curGameContent.type == "newEra") { updateGraph(); }
							
			if (curGameContent.type == "newEra" || curGameContent.type == "setup") {
				t = document.createTextNode(curGameContent.hook);
				eDisplay.appendChild(t);
				headerDiv.classList.add("fadeInAnimation");				
			} else {
				h = document.createTextNode(curGameContent.hook);
				hDisplay.appendChild(h);
				headerDiv.classList.add("fadeInAnimation");
			}
			
			if (curGameContent.text != "") {
				t = document.createTextNode(curGameContent.text);
				tDisplay.appendChild(t);
				mainDiv.classList.add("fadeInAnimation");
			//	mainDiv.style.animationDelay = "1s";
			}
			
			if (curGameContent.answers) {
				for(var i=0; i<curGameContent.answers.length; i++) {

					(function(i) {
						var para = createPElement(curGameContent.answers[i].answer, 0, "0.4em");
						para.answerIndex = i;									
						para.addEventListener("click", function() {
							var answerChosen = curGameContent.answers[para.answerIndex];
							resolveScore(answerChosen);
							if (curGameContent.type != "setup" && curGameContent.type != "newEra") { updateGraph(); }
							requestAnimationFrame(frame);
							displayContentComplete = false;
							
							resetAnimation(headerDiv,mainDiv,answerDiv);	
					
						});
						aDisplay.appendChild(para);						
					})(i)
					answerDiv.classList.add("fadeInAnimation");
					//answerDiv.style.animationDelay = "1.5s";
				}
				
			} else {
				var para = createPElement("Continue...",0,0);
				
				para.addEventListener("click", function() {						
					resolveScore(curGameContent);
					requestAnimationFrame(frame);
					displayContentComplete = false;
					
					resetAnimation(headerDiv,mainDiv,answerDiv);
					
				})
				aDisplay.appendChild(para);
				answerDiv.classList.add("fadeInAnimation");
				//answerDiv.style.animationDelay = "1.5s";
			}
				
			displayContentComplete = true;			
		}
		
		function resetAnimation(...args) {
		
			for (var i=0; i<args.length; i++) {
				args[i].classList.remove("fadeInAnimation");
				args[i].offsetWidth = args[i].offsetWidth;
				args[i].classList.add("fadeInAnimation");
			}
			
		
		}
	
		function resolveScore(answerObj) {
		
			//Could be impoved with better json structure
			if (answerObj.pop % 1 != 0) {
				gameObject.gameScore.pop *= answerObj.pop;
			} else {
				gameObject.gameScore.pop += answerObj.pop;
			}

			if (answerObj.econ % 1 != 0) {
				gameObject.gameScore.econ *= answerObj.econ;
			} else {
				gameObject.gameScore.econ += answerObj.econ;
			}

			if (answerObj.rep % 1 != 0) {
				gameObject.gameScore.rep *= answerObj.rep;
			} else {
				gameObject.gameScore.rep += answerObj.rep;
			}

			if (answerObj.sol % 1 != 0) {
				gameObject.gameScore.sol *= answerObj.sol;
			} else {
				gameObject.gameScore.sol += answerObj.sol;
			}		

					
		}
		
		
		function resetCanvas() {
			var qDisplay = document.querySelectorAll(".question-canvas");
			for (i = 0; i < qDisplay.length; i++) {
				qDisplay[i].textContent = "";
				//qDisplay[i].style.opacity = 0;
			}	
			if (graph) {graph.render();	}
		}
		
		
		
		function createPElement(s, mt, mb) {
	
			var para = document.createElement("p");
			var a = document.createTextNode(s);
			
			para.appendChild(a);
			para.style.cursor = "default";
			//para.style.pointerEvents = "none";
			
			if (mt != undefined) { para.style.marginTop = mt; } 
			if (mb != undefined) { para.style.marginBottom = mb; }
	
			return para;
		}
		
		function updateGraph() {

			scoreData.pop[gameObject.contentCount].y = gameObject.gameScore.pop;
			scoreData.econ[gameObject.contentCount].y = gameObject.gameScore.econ;
			scoreData.rep[gameObject.contentCount].y = gameObject.gameScore.rep;
			scoreData.sol[gameObject.contentCount].y = gameObject.gameScore.sol;
			
			
			gameObject.contentCount++;
			
			graph.update();


		}

	
		function drawGraph() {
			
			$('#chart_container').html(
			'<div id="chart"></div><div id="legend_container"></div><div id="slider"></div><div id="x_axis"></div>'
			);	

			scoreData = {
				"pop":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"rep":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"econ":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"sol":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}]
			};
			
			
			graph = new Rickshaw.Graph({
				element: document.querySelector("#chart"),
				renderer: 'lineplot',
				series: [
				{
					data: scoreData.pop,
					name: 'Population',
					color: '#4682b4'
				}, {
					data: scoreData.econ,
					name: 'Economy',
					color: '#9cc1e0'
				}, {
					data: scoreData.rep,
					name: 'Reputation',
					color: '#22f1e0'
				}, {
					data: scoreData.sol,
					name: 'Solidarity',
					color: '#1e0992'
				}]
			});
			
			var format = function(n) {

				var map = {
					0: '1910',
					1: '',
					2: '',
					3: '1919',
					4: '',
					5: '',
					6: '1937',
					7: '',
					8: '',
					9: '1946',
					10: '',
					11: '',
					12: '1956',
					13: '',
					14: '',
					15: '1965',
					16: '',
					17: '',
					18: '1976',
					19: '',
					20: '',
					21: '1986',
					22: '',
					23: '',
					24: '1996',
					25: '',
					26: '',
					27: '2005',
					28: '',
					29: '',
					30: 'Present',
				};

				return map[n];
			}
			
			var x_axis = new Rickshaw.Graph.Axis.X( { 
				graph: graph,
				orientation: 'bottom',
				element: document.getElementById('x_axis'),
				tickFormat: format				
			} );			

			var hoverDetail = new Rickshaw.Graph.HoverDetail({
				graph: graph,
				formatter: function(series, x, y) {
					var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
					var data = '<span class="detail_data">' + series.name + ": " + parseInt(y) + '</span>';
					var content = swatch + data;
					return content;
				}
			});
					
			x_axis.render();
	
		}
		
	</script>


</body>

</html>
