 <!DOCTYPE HTML>

<html>

<head>
	
	<meta charset="UTF-8">
	<title>The Settlers of Palestine</title>
	<script src="js/jquery-2.2.4.js"></script>
	<script src="js/bootstrap.js"/></script>
	<link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
	<link type="text/css" rel="stylesheet" href="css/bootstrap.css">
	<script src="js/d3.v2.js"></script>

	<script src="js/rickshaw.min.js"></script>
	
	

	
	<style>
		
		.jumbotron {
			max-width: 1920px;
			border-radius: 0 !important;
			background-color: #dddddd;
		}
		
		.main-group {
			margin: 0 2% 0 2%;
		}
		
		.hook-text {
			display: block;
			font-weight: bold;
			margin-bottom: 1em;
		}
		
		.panel {
			border-radius: 30px;
			background-color: #0992b2;
			max-width: 50%;
			min-width: 50%;
			animation: pulse 5s infinite;
		}
		
		.panel-footer {
			border-radius: 30px;
			background-color: #ffa858;
			max-width: 50%;
		}
		
		.well {
			background-color: #ffa858;
			border-radius: 30px;
			padding-top: 20px;
			padding-right: 20px;
			padding-left: 20px;
			animation: pulse 5s infinite;
		}
		
		@keyframes pulse {
			0% {
				background-color: #000000;
			}
			100% {
				background-color: #FFFFFF;
			}
		
		}
		
		
		.main-text-panel {
			min-height: 
		}
		
		#answer-canvas {
		 margin-bottom: 2em;
		}
		
		@media screen and (min-width: 320px) {
			#chart {width: 320px; height: 72px;}
		}
		
		@media screen and (min-width: 480px) {
			#chart {width: 480px; height: 109px;}
		}
		
		@media screen and (min-width: 1224px) {
			#chart {width: 1100px; height: 250px;}		
		}
		
		.question-canvas{

			white-space: pre-line; /*Not sure why this works... Need to check compatibility with all browsers/platforms http://stackoverflow.com/questions/9980416/how-can-i-insert-new-line-carriage-returns-into-an-element-textcontent*/		
		}
		.rickshaw_graph .detail .x_label {display:none; }
		.rickshaw_graph .detail .item { line-height: 1.4; padding: 0.5em }
		.detail_swatch {float:right; width: 10px; height: 10px; margin: 2.5px 0 0 95px }
		/*.rickshaw_graph .detail .date { color: #a0a0a0 }
		.detail_data { float: left; display: inline; }*/
		
	</style>

</head>

<body>
	
	<div class="container-fluid">
		<img src="images/header_1920.jpg" class="img-responsive" id="header-image">
		<div class="jumbotron">		
			
			<div class="row panel">
				<div class="col-lg-12">
					<h1 class="text-center question-canvas" id="era-title"></h1>
					<h3 class="text-center question-canvas" id="hook-text"></h3>
				</div>
			</div>
			
			<div class="row main-text-panel main-group">	
				<div  class="col-lg-12 well well-sm">
					<p class="text-justify question-canvas" id="text-canvas"></p>
				</div>
			</div>
		
			<div class="row main-group panel-footer">
				<div class="col-lg-4 col-lg-offset-8">
					<div class="text-right question-canvas" id="answer-canvas"></div> <!--text-muted-->
				</div>
			</div>
			
			<div class="row">
				<div class="col-lg-10 col-lg-offset-1">
					<div id="chart_container">
						<div id="chart"></div>
						<div id="legend_container">
							<div id="smoother" title="Smoothing"></div>
							<div id="legend"></div>
						</div>
						<div id="slider"></div>
						<div id="x_axis"></div>
					</div>
				</div>
			</div>
		
		</div>
	</div>


	<script language="JavaScript">
	
			var score = {};
			var QUESTIONS_PER_ERA = 2;
			var QUESTIONS_PER_GAME = 20;
		var graph;
		
		var scoreData = { "pop": [], "rep": [], "econ": [], "sol": []};

		var setupMultipliers = {"econ":1,"pop":1,"rep":1,"sol":1};
		var jsonData;
		
		var scoreData = {};
		
		var gameObject = {};
		
		
		var hDisplay = document.querySelector("#hook-text");
		var eDisplay = document.querySelector("#era-title");			
		var tDisplay = document.querySelector("#text-canvas");
		var aDisplay = document.querySelector("#answer-canvas");
			
		var counter = 1;
		var displayContentComplete = false;
		
		var DISPLAY_ANIM_DELAY = 1500;
		var DISPLAY_ANIM_DELAY_OFFSET = 1000;
		
		function frame() {
			if (!displayContentComplete) {
				resetCanvas();
				
				if (gameObject.gameContent.length > 0) {					
					displayContent();
					
				} else {
					displayGameOver();
				}
			}
			requestAnimationFrame(frame);
		}

		function displayGameOver() {
			
			var h = document.createTextNode("Game Over");
			var t = document.createTextNode("Your kibbutz has managed to persist through many hardships to contemporary times. Was the 'experiment' a success? Only you can judge...");					
			hDisplay.appendChild(h);
			tDisplay.appendChild(t)

			//$(tDisplay).animate({opacity: "1.0"}, DISPLAY_ANIM_DELAY, "linear");	
			
			var para = createPElement("Click to replay...",0,0);
			
			para.addEventListener("click", function() {
				loadScript("data/SoPQuestionDataTEMP.json", gameSetup);
				displayContentComplete = false;
			});
			aDisplay.appendChild(para);	
			/*$(aDisplay).animate({opacity: "1.0"}, DISPLAY_ANIM_DELAY, "linear", function() {
				para.style.pointerEvents = "auto";
			});	*/
			displayContentComplete = true;
		}
		
		function loadScript(url, callback) {
			var head = document.getElementsByTagName('head')[0];
			var script = document.createElement('script');
			script.type = 'text/javascript';
			script.src = url;

			script.onreadystatechange = callback;
			script.onload = callback;
			
			head.appendChild(script);
		}

		function gameSetup() {

			gameObject.gameContent = generateGameContent(SoPQuestionData);	
			gameObject.gameScore = {"pop": 0, "econ": 0, "rep": 0, "sol": 0};
			gameObject.contentCount = 0;
			
			drawGraph();
			
			requestAnimationFrame(frame);

		}
		
		
		function generateGameContent(json) {
		
			var arr = [];
					
			for (var i=0; i<json.length; i++) {
				
				arr.push(json[i].newEra);
				var	questionArray = json[i].questions;	
				
				if (json[i].type == "setup") {
					arr.push(questionArray[0]);
					arr.push(questionArray[1]);
				} else {						
					var bossQuestionIndex = getIndex(questionArray, "B");
									
					if (bossQuestionIndex > 0) {					
						var tempObj = questionArray.splice(bossQuestionIndex,1);
						arr.push(questionArray.splice(Math.floor(questionArray.length*Math.random()),1)[0]);
						arr.push(tempObj[0]);
					} else {
						for (var j=0; j<QUESTIONS_PER_ERA; j++) {
							arr.push(questionArray.splice(Math.floor(questionArray.length*Math.random()),1)[0]);
						}
					}				
				}
			}
			
			return arr;

		}
		
		function getIndex(data, type) {
			
			for (var i=0; i<data.length; i++) {
				if (data[i].type === type) {
					return i;					
				}												
			}
			return -1;
		}
		
		loadScript("data/SoPQuestionDataTEMP.json", gameSetup);	
		
		
		function displayContent() {
			
			var h, t, a;
			var curGameContent = gameObject.gameContent.shift();
			
			if (curGameContent.type == "newEra") { updateGraph(); }
			
			if (curGameContent.hook != "") {
				h = document.createTextNode(curGameContent.hook);
				hDisplay.appendChild(h);
			}
			
			if (curGameContent.text != "") {
				t = document.createTextNode(curGameContent.text);
				tDisplay.appendChild(t);
			}
			
			if (curGameContent.answers) {
				for(var i=0; i<curGameContent.answers.length; i++) {

					(function(i) {
						var para = createPElement(curGameContent.answers[i].answer, i, 0);
						para.answerIndex = i;									
						para.addEventListener("click", function() {
							var answerChosen = curGameContent.answers[para.answerIndex];
							resolveScore(answerChosen);
							if (curGameContent.type != "setup" && curGameContent.type != "newEra") { updateGraph(); }
							requestAnimationFrame(frame);
							displayContentComplete = false;
						});
						aDisplay.appendChild(para);
					})(i)
				}
			} else {
				var para = createPElement("Continue...",0,0);
				
				para.addEventListener("click", function() {						
					resolveScore(curGameContent);
					requestAnimationFrame(frame);
					displayContentComplete = false;
				})
				aDisplay.appendChild(para);
			}
				
			displayContentComplete = true;			
		}
			
		function resolveScore(answerObj) {
		
			//Could be impoved with better json structure
			if (answerObj.pop % 1 != 0) {
				gameObject.gameScore.pop *= answerObj.pop;
			} else {
				gameObject.gameScore.pop += answerObj.pop;
			}

			if (answerObj.econ % 1 != 0) {
				gameObject.gameScore.econ *= answerObj.econ;
			} else {
				gameObject.gameScore.econ += answerObj.econ;
			}

			if (answerObj.rep % 1 != 0) {
				gameObject.gameScore.rep *= answerObj.rep;
			} else {
				gameObject.gameScore.rep += answerObj.rep;
			}

			if (answerObj.sol % 1 != 0) {
				gameObject.gameScore.sol *= answerObj.sol;
			} else {
				gameObject.gameScore.sol += answerObj.sol;
			}		

					
		}
		
		
		function resetCanvas() {
			var qDisplay = document.querySelectorAll(".question-canvas");
			for (i = 0; i < qDisplay.length; i++) {
				qDisplay[i].textContent = "";
				//qDisplay[i].style.opacity = 0;
			}	
			if (graph) {graph.render();	}
		}
		
		
		
		function createPElement(s, mt, mb) {
	
			var para = document.createElement("p");
			var a = document.createTextNode(s);
			
			para.appendChild(a);
			para.style.cursor = "default";
			//para.style.pointerEvents = "none";
			
			if (mt != undefined) { para.style.marginTop = mt; } 
			if (mb != undefined) { para.style.marginBottom = mb; }
	
			return para;
		}
		
		function updateGraph() {
			/*scoreData.pop[2*(score.era-1)+ score.numQuestions].y = score.pop;
			if (score.rep > 100) {score.rep = 100; }
			if (score.rep < 0) { score.rep = 0; }
			scoreData.rep[2*(score.era-1) + score.numQuestions].y = score.rep;
			scoreData.econ[2*(score.era-1) + score.numQuestions].y = score.econ;
			if (score.sol > 100) {score.sol = 100; }
			if (score.sol < 0) { score.sol = 0; }
			scoreData.sol[2*(score.era-1) + score.numQuestions].y = score.sol;*/

			scoreData.pop[gameObject.contentCount].y = gameObject.gameScore.pop;
			scoreData.econ[gameObject.contentCount].y = gameObject.gameScore.econ;
			scoreData.rep[gameObject.contentCount].y = gameObject.gameScore.rep;
			scoreData.sol[gameObject.contentCount].y = gameObject.gameScore.sol;
			
			
			gameObject.contentCount++;
			
			graph.update();


		}
		
		function clearGraph() {
			$('#chart_container').html(
			'<div id="chart"></div><div id="legend_container"></div><div id="slider"></div><div id="x_axis"></div>'
			);	

			/*scoreData = {
				"pop":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"rep":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"econ":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"sol":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}]
			};*/
		}
	
		function drawGraph() {
			
			$('#chart_container').html(
			'<div id="chart"></div><div id="legend_container"></div><div id="slider"></div><div id="x_axis"></div>'
			);	

			scoreData = {
				"pop":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"rep":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"econ":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}], 
				"sol":[{x:0, y:null},{x:1, y:null},{x:2, y:null},{x:3, y:null},{x:4, y:null},{x:5, y:null},{x:6, y:null},{x:7, y:null},{x:8, y:null},{x:9, y:null},{x:10, y:null},{x:11, y:null},{x:12, y:null},{x:13, y:null},{x:14, y:null},{x:15, y:null},{x:16, y:null},{x:17, y:null},{x:18, y:null},{x:19, y:null},{x:20, y:null},{x:21, y:null},{x:22, y:null},{x:23, y:null},{x:24, y:null},{x:25, y:null},{x:26, y:null},{x:27, y:null},{x:28, y:null},{x:29, y:null},{x:30, y:null}]
			};
			
			var w = document.querySelector("#chart").width;
			var h = document.querySelector("#chart").height;
			
			graph = new Rickshaw.Graph({
				element: document.querySelector("#chart"),
				width: w,
				height: h,
				renderer: 'lineplot',
				series: [
				{
					data: scoreData.pop,
					name: 'Population',
					color: '#4682b4'
				}, {
					data: scoreData.econ,
					name: 'Economy',
					color: '#9cc1e0'
				}, {
					data: scoreData.rep,
					name: 'Reputation',
					color: '#22f1e0'
				}, {
					data: scoreData.sol,
					name: 'Solidarity',
					color: '#1e0992'
				}]
			});
			
			var format = function(n) {

				var map = {
					0: '1910',
					1: '',
					2: '',
					3: '1919',
					4: '',
					5: '',
					6: '1937',
					7: '',
					8: '',
					9: '1946',
					10: '',
					11: '',
					12: '1956',
					13: '',
					14: '',
					15: '1965',
					16: '',
					17: '',
					18: '1976',
					19: '',
					20: '',
					21: '1986',
					22: '',
					23: '',
					24: '1996',
					25: '',
					26: '',
					27: '2005',
					28: '',
					29: '',
					30: 'Present',
				};

				return map[n];
			}
			
			var x_axis = new Rickshaw.Graph.Axis.X( { 
				graph: graph,
				orientation: 'bottom',
				element: document.getElementById('x_axis'),
				tickFormat: format				
			} );			

			var hoverDetail = new Rickshaw.Graph.HoverDetail({
				graph: graph,
				formatter: function(series, x, y) {
					var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
					var data = '<span class="detail_data">' + series.name + ": " + parseInt(y) + '</span>';
					var content = swatch + data;
					return content;
				}
			});
					
			x_axis.render();
	
		}
		
	</script>


</body>

</html>
